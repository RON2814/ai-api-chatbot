<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>AI Chatbot</title>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600&family=DM+Mono:wght@400;500&display=swap"
            rel="stylesheet"
        />
        <style>
            :root {
                --bg: #0b1a2a;
                --panel: #0f2438;
                --muted: #9fb3c8;
                --text: #e8eef6;
                --accent: #f97316;
                --accent-soft: rgba(249, 115, 22, 0.12);
                --border: rgba(255, 255, 255, 0.07);
                --shadow: 0 18px 60px rgba(5, 8, 20, 0.55);
            }

            * {
                box-sizing: border-box;
            }
            body {
                margin: 0;
                min-height: 100vh;
                background: radial-gradient(
                        circle at 20% 20%,
                        rgba(15, 82, 91, 0.18),
                        transparent 35%
                    ),
                    radial-gradient(
                        circle at 80% 10%,
                        rgba(26, 63, 117, 0.18),
                        transparent 32%
                    ),
                    linear-gradient(135deg, #0b1a2a, #0c1f32 50%, #0b2a36);
                color: var(--text);
                font-family: "Space Grotesk", "Segoe UI", system-ui,
                    -apple-system, sans-serif;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 32px 18px;
            }

            .shell {
                width: min(1100px, 100%);
                background: var(--panel);
                border: 1px solid var(--border);
                border-radius: 18px;
                box-shadow: var(--shadow);
                overflow: hidden;
            }

            header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 18px 22px;
                border-bottom: 1px solid var(--border);
                background: rgba(255, 255, 255, 0.02);
            }

            .brand {
                display: flex;
                align-items: center;
                gap: 12px;
                font-weight: 600;
                letter-spacing: 0.02em;
            }

            .badge {
                padding: 6px 12px;
                border-radius: 999px;
                background: var(--accent-soft);
                color: var(--accent);
                font-size: 13px;
                border: 1px solid rgba(249, 115, 22, 0.2);
            }

            main {
                display: grid;
                grid-template-columns: 1fr 320px;
                gap: 0;
            }

            .chat-col {
                padding: 0 22px 22px 22px;
                border-right: 1px solid var(--border);
            }

            .messages {
                height: 62vh;
                max-height: 600px;
                overflow-y: auto;
                padding: 14px 4px 14px 0;
                display: flex;
                flex-direction: column;
                gap: 12px;
                scroll-behavior: smooth;
            }

            .bubble {
                padding: 14px 16px;
                border-radius: 14px;
                border: 1px solid var(--border);
                background: rgba(255, 255, 255, 0.02);
                color: var(--text);
                line-height: 1.5;
                box-shadow: 0 10px 28px rgba(0, 0, 0, 0.18);
                white-space: pre-wrap;
            }

            .bubble.user {
                align-self: flex-end;
                background: var(--accent-soft);
                border-color: rgba(249, 115, 22, 0.35);
                color: #ffe9d6;
            }

            .bubble.bot {
                align-self: flex-start;
            }

            form {
                display: grid;
                grid-template-columns: 1fr 120px;
                gap: 12px;
                padding: 16px 0 10px 0;
                position: sticky;
                bottom: 0;
                background: linear-gradient(
                    180deg,
                    rgba(15, 36, 56, 0.8),
                    var(--panel)
                );
                backdrop-filter: blur(6px);
            }

            .provider-row {
                grid-column: 1 / span 2;
                display: flex;
                gap: 10px;
                align-items: center;
                justify-content: flex-end;
                padding: 4px 2px 0 2px;
            }

            .provider-row select,
            .provider-row input {
                border: 1px solid var(--border);
                background: rgba(255, 255, 255, 0.03);
                color: var(--text);
                border-radius: 10px;
                padding: 8px 10px;
                font-size: 13px;
            }

            .provider-row input {
                width: 180px;
            }

            textarea {
                width: 100%;
                min-height: 70px;
                resize: vertical;
                padding: 12px 14px;
                border-radius: 12px;
                border: 1px solid var(--border);
                background: rgba(255, 255, 255, 0.03);
                color: var(--text);
                font-size: 15px;
                font-family: "Space Grotesk", sans-serif;
                transition: border 0.2s ease, box-shadow 0.2s ease;
            }

            textarea:focus {
                outline: none;
                border-color: rgba(249, 115, 22, 0.5);
                box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.15);
            }

            button {
                border: none;
                border-radius: 12px;
                background: linear-gradient(135deg, var(--accent), #ffb14c);
                color: #0a0a0a;
                font-weight: 600;
                letter-spacing: 0.01em;
                cursor: pointer;
                transition: transform 0.1s ease, box-shadow 0.2s ease;
                box-shadow: 0 12px 24px rgba(249, 115, 22, 0.28);
                padding: 10px 14px;
            }

            .side button {
                padding: 8px 12px;
            }

            button:active {
                transform: translateY(1px);
            }
            button:disabled {
                opacity: 0.65;
                cursor: not-allowed;
                box-shadow: none;
            }

            .bubble-actions {
                display: flex;
                gap: 6px;
                justify-content: flex-end;
                margin-top: 6px;
            }
            .icon-btn {
                padding: 6px 8px;
                border-radius: 10px;
                font-size: 13px;
            }

            .side {
                padding: 22px;
                display: grid;
                gap: 16px;
            }

            .card {
                border: 1px solid var(--border);
                border-radius: 14px;
                padding: 14px 16px;
                background: rgba(255, 255, 255, 0.02);
            }

            .muted {
                color: var(--muted);
                font-size: 14px;
                line-height: 1.6;
            }
            .mono {
                font-family: "DM Mono", "Space Grotesk", monospace;
            }
            .divider {
                height: 1px;
                background: var(--border);
                margin: 12px 0;
            }

            .status {
                display: inline-flex;
                align-items: center;
                gap: 8px;
                padding: 8px 12px;
                border-radius: 12px;
                background: rgba(255, 255, 255, 0.03);
                border: 1px solid var(--border);
                font-size: 13px;
                color: var(--muted);
            }

            .dot {
                width: 10px;
                height: 10px;
                border-radius: 50%;
                background: #10b981;
                box-shadow: 0 0 0 6px rgba(16, 185, 129, 0.15);
            }

            .error {
                color: #fca5a5;
                background: rgba(248, 113, 113, 0.1);
                border: 1px solid rgba(248, 113, 113, 0.2);
                border-radius: 12px;
                padding: 12px 14px;
                margin: 8px 0 0 0;
                display: none;
            }

            @media (max-width: 960px) {
                main {
                    grid-template-columns: 1fr;
                }
                .chat-col {
                    border-right: none;
                    border-bottom: 1px solid var(--border);
                }
                .messages {
                    height: 56vh;
                }
                .provider-row {
                    justify-content: flex-start;
                    flex-wrap: wrap;
                    gap: 8px;
                }
                textarea {
                    min-height: 56px;
                }
            }
        </style>
    </head>
    <body>
        <div class="shell">
            <header>
                <div class="brand">
                    <div class="badge">AI Chatbot</div>
                    <div>Project Console</div>
                </div>
                <div class="status">
                    <span class="dot"></span>Backend reachable
                </div>
            </header>

            <main>
                <section class="chat-col">
                    <div id="messages" class="messages"></div>

                    <form id="chat-form">
                        <textarea
                            id="message"
                            name="message"
                            placeholder="Ask anything..."
                            required
                        ></textarea>
                        <button type="submit" id="send">Send</button>
                        <div class="provider-row">
                            <span class="muted" style="font-size: 12px"
                                >Provider:</span
                            >
                            <select id="provider">
                                <option value="">auto</option>
                                <option value="gemini">gemini</option>
                                <option value="openai">openai</option>
                            </select>
                            <input id="model" placeholder="model (optional)" />
                        </div>
                        <div id="error" class="error"></div>
                    </form>
                </section>

                <aside class="side">
                    <div class="card">
                        <div style="font-weight: 600; margin-bottom: 6px">
                            Quick actions
                        </div>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap">
                            <button type="button" id="qa-clear">
                                Clear chat
                            </button>
                            <button type="button" id="qa-copy">
                                Copy chat
                            </button>
                            <button type="button" id="qa-export">
                                Export .txt
                            </button>
                        </div>
                        <div class="muted" style="margin-top: 8px">
                            Simple utilities for your current conversation.
                        </div>
                    </div>
                    <div class="card">
                        <div style="font-weight: 600; margin-bottom: 6px">
                            Session
                        </div>
                        <div class="muted">
                            Provider:
                            <span class="mono" id="cur-provider">auto</span>
                        </div>
                        <div class="muted">
                            Model:
                            <span class="mono" id="cur-model">default</span>
                        </div>
                        <div
                            class="muted"
                            id="last-finish"
                            style="margin-top: 6px"
                        ></div>
                    </div>
                </aside>
            </main>
        </div>

        <script>
            const form = document.getElementById("chat-form");
            const input = document.getElementById("message");
            const sendBtn = document.getElementById("send");
            const logEl = document.getElementById("messages");
            const errorEl = document.getElementById("error");
            const providerSelect = document.getElementById("provider");
            const modelInput = document.getElementById("model");
            const curProvider = document.getElementById("cur-provider");
            const curModel = document.getElementById("cur-model");
            const lastFinish = document.getElementById("last-finish");
            const qaClear = document.getElementById("qa-clear");
            const qaCopy = document.getElementById("qa-copy");
            const qaExport = document.getElementById("qa-export");

            const API_URL = "/api/chat";
            const STREAM_URL = "/api/stream";

            const addBubble = (role, html = "") => {
                const el = document.createElement("div");
                el.className = `bubble ${role}`;
                el.innerHTML = html;
                logEl.appendChild(el);
                logEl.scrollTop = logEl.scrollHeight;
                return el;
            };

            // Minimal markdown renderer: bold, italic, inline code, fenced code, line breaks.
            const renderMarkdown = (text) => {
                const escape = (s) =>
                    s
                        .replace(/&/g, "&amp;")
                        .replace(/</g, "&lt;")
                        .replace(/>/g, "&gt;");
                let html = escape(text);
                // fenced code blocks ``` ```
                html = html.replace(/```([\s\S]*?)```/g, (m, p1) => {
                    return `<pre><code>${p1}</code></pre>`;
                });
                html = html.replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");
                html = html.replace(/\*(.*?)\*/g, "<em>$1</em>");
                html = html.replace(/`([^`]+)`/g, "<code>$1</code>");
                html = html.replace(/\n/g, "<br>");
                return html;
            };

            // Reveal one line at a time for quicker perceived speed.
            const typeOutLines = (el, text, lineDelay = 60) =>
                new Promise((resolve) => {
                    const lines = text.split(/\n/);
                    let idx = 0;
                    const showNext = () => {
                        if (idx >= lines.length) return resolve();
                        const slice = lines.slice(0, idx + 1).join("\n");
                        el.innerHTML = renderMarkdown(slice);
                        logEl.scrollTop = logEl.scrollHeight;
                        idx += 1;
                        setTimeout(showNext, lineDelay);
                    };
                    showNext();
                });

            const setLoading = (loading) => {
                sendBtn.disabled = loading;
                sendBtn.textContent = loading ? "Sending…" : "Send";
            };

            const showError = (msg) => {
                errorEl.textContent = msg;
                errorEl.style.display = msg ? "block" : "none";
            };

            // Sidebar helpers
            const updateSessionInfo = (fromResponse) => {
                curProvider.textContent = providerSelect?.value || "auto";
                curModel.textContent =
                    modelInput?.value || fromResponse?.model || "default";
                if (fromResponse?.finish_reason) {
                    lastFinish.textContent =
                        "finish_reason: " + fromResponse.finish_reason;
                }
            };

            const bubblesToText = () => {
                const items = Array.from(logEl.querySelectorAll(".bubble"));
                return items
                    .map((el) => {
                        const role = el.classList.contains("user")
                            ? "User"
                            : "Assistant";
                        return `${role}: ${el.innerText}`;
                    })
                    .join("\n\n");
            };

            qaClear?.addEventListener("click", () => {
                logEl.innerHTML = "";
                lastFinish.textContent = "";
            });

            qaCopy?.addEventListener("click", async () => {
                try {
                    await navigator.clipboard.writeText(bubblesToText());
                } catch (e) {
                    console.error("Copy failed", e);
                }
            });

            qaExport?.addEventListener("click", () => {
                try {
                    const txt = bubblesToText();
                    const blob = new Blob([txt], { type: "text/plain" });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    const ts = new Date().toISOString().replace(/[:.]/g, "-");
                    a.href = url;
                    a.download = `chat-${ts}.txt`;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    URL.revokeObjectURL(url);
                } catch (e) {
                    console.error("Export failed", e);
                }
            });

            providerSelect?.addEventListener("change", () =>
                updateSessionInfo()
            );
            modelInput?.addEventListener("change", () => updateSessionInfo());
            updateSessionInfo();

            let lastUserText = "";

            form.addEventListener("submit", async (e) => {
                e.preventDefault();
                const text = input.value.trim();
                if (!text) return;

                showError("");
                addBubble("user", text);
                setLoading(true);
                input.value = "";
                lastUserText = text;

                try {
                    const res = await fetch(STREAM_URL, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            message: text,
                            provider: providerSelect?.value || undefined,
                            model: modelInput?.value || undefined,
                        }),
                    });
                    if (!res.ok || !res.body) {
                        throw new Error(`HTTP ${res.status}`);
                    }
                    const botBubble = addBubble("bot", "");
                    const reader = res.body.getReader();
                    const decoder = new TextDecoder("utf-8");
                    let buffer = "";
                    let lastFinish = null;
                    while (true) {
                        const { value, done } = await reader.read();
                        if (done) break;
                        buffer += decoder.decode(value, { stream: true });
                        const parts = buffer.split("\n\n");
                        buffer = parts.pop();
                        for (const ev of parts) {
                            const line = ev
                                .split("\n")
                                .find((l) => l.startsWith("data:"));
                            if (!line) continue;
                            const json = line.slice(5).trim();
                            if (!json) continue;
                            let obj = {};
                            try {
                                obj = JSON.parse(json);
                            } catch {}
                            if (obj.delta) {
                                const current = botBubble.innerText || "";
                                const next = current + obj.delta;
                                botBubble.innerHTML = renderMarkdown(next);
                                logEl.scrollTop = logEl.scrollHeight;
                            }
                            if (obj.error) {
                                showError(obj.detail || obj.error);
                            }
                            if (obj.done) {
                                lastFinish = obj.finish_reason || null;
                                updateSessionInfo({
                                    model: obj.model,
                                    finish_reason: obj.finish_reason,
                                });
                            }
                        }
                    }
                    if (
                        lastFinish &&
                        ["MAX_TOKENS", "length"].includes(String(lastFinish))
                    ) {
                        const warn = document.createElement("div");
                        warn.className = "muted";
                        warn.style.fontSize = "12px";
                        warn.style.marginTop = "6px";
                        warn.textContent =
                            "Response may be cut short (finish_reason=" +
                            lastFinish +
                            ").";
                        botBubble.appendChild(warn);
                    }
                    // Add a refresh icon beside this bot response to regenerate
                    const actions = document.createElement("div");
                    actions.className = "bubble-actions";
                    const refresh = document.createElement("button");
                    refresh.type = "button";
                    refresh.className = "icon-btn";
                    refresh.title = "Regenerate this answer";
                    refresh.textContent = "↻";
                    refresh.addEventListener("click", () => {
                        input.value = text; // re-use the same prompt
                        form.requestSubmit();
                    });
                    actions.appendChild(refresh);
                    botBubble.appendChild(actions);
                } catch (err) {
                    showError(err.message || "Something went wrong");
                    addBubble(
                        "bot",
                        "⚠️ There was an issue processing your request."
                    );
                    console.error("/api/stream failed", err);
                } finally {
                    setLoading(false);
                }
            });

            // Enter-to-send (Shift+Enter for newline)
            input.addEventListener("keydown", (e) => {
                if (e.key === "Enter" && !e.shiftKey) {
                    e.preventDefault();
                    form.requestSubmit();
                }
            });

            // Removed global Regenerate button; per-message refresh icon is added next to each AI response.

            // Seed a welcome message
            addBubble("bot", "Hi! I am your AI assistant. Ask me anything.");
        </script>
    </body>
</html>
